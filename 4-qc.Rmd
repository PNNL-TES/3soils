---
title: "4-qc"
author: "3soils experiment"
date: "11/28/2018"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
source("0-functions.R")
```

```{r read_data, echo=FALSE, cache=TRUE, message=FALSE}
summarydata <- read_csv(SUMMARYDATA_FILE)
summarydata_clean <- read_csv(SUMMARYDATA_CLEAN_FILE, guess_max = 1e6)
valvemap <- read_csv(VALVEMAP_COMBINED_FILE)
rawdata_samples <- read_csv(RAWDATA_SAMPLES_FILE)
```

## valvemap data with no Picarro matches:

```{r, echo=FALSE}
valvemap %>% 
  filter(picarro_records == 0) %>% 
  select(SampleID, Site, Treatment, Picarro_start, sequence_valve, picarro_records) ->
  unmatched_valvemap
```

`r nrow(unmatched_valvemap)` of `r nrow(valvemap)` valve map entries had no matches in Picarro data.

```{r, echo=FALSE}
knitr::kable(unmatched_valvemap, caption = "Unmatched valvemap data")
qplot(Picarro_start, SampleID, color = picarro_records == 0, data = valvemap) +
  ggtitle("unmatched_valvemap_data") + scale_color_discrete("unmatched")
```

## Picarro data with no valvemap matches:

```{r, echo=FALSE}
```

`r sum(!summarydata$matched)` of `r nrow(summarydata)` Picarro samples had no matches in valvemap data.

```{r}
qplot(DATETIME, MPVPosition, color = matched, data = summarydata) +
  ggtitle("unmatched_picarro_data")

```

## summarydata statistics

There are `r nrow(summarydata_clean)` different samples.

```{r, echo=FALSE}
#hist(summarydata_clean$CO2_ppm_s)
#hist(summarydata_clean$CH4_ppb_s)
summarydata_clean %>% 
  select(CO2_ppm_s, CH4_ppb_s, N) %>% 
  summary
summarydata_clean %>% 
  filter(!is.na(CO2_ppm_s)) %>% 
  group_by(Site) %>% 
  summarise(CO2_ppm_s = mean(CO2_ppm_s), CH4_ppb_s = mean(CH4_ppb_s), Picarro_obs = sum(N), N = n()) %>% 
  knitr::kable(caption = "Summary data by site")
summarydata_clean %>% 
  filter(!is.na(CO2_ppm_s)) %>% 
  group_by(SampleID, PHASE) %>% 
  summarise(CO2_ppm_s = mean(CO2_ppm_s), CH4_ppb_s = mean(CH4_ppb_s), Picarro_obs = sum(N), N = n()) -> 
  sumry
knitr::kable(sumry, caption = "Summary data by sample")
```

### Negative CO2 flux samples

```{r negs, echo=FALSE}
negs <- filter(sumry, CO2_ppm_s < 0)
qplot(CO2_ppm_s, data = filter(summarydata_clean, SampleID %in% negs$SampleID), bins = 30) + 
  facet_wrap(~SampleID) + ggtitle("Negative-CO2 flux samples")

qplot(DATETIME, CO2_ppm_s, data=summarydata_clean, group=SampleID, geom="line", color = Site) + facet_wrap(~PHASE)
qplot(DATETIME, CH4_ppb_s, data=summarydata_clean, group=SampleID, geom="line", color = Site) + facet_wrap(~PHASE)

negs %>% 
  select(SampleID, PHASE) %>% 
  left_join(summarydata_clean, by = c("SampleID", "PHASE")) %>% 
  left_join(select(rawdata_samples, samplenum, elapsed_seconds, CO2_dry), by = "samplenum") %>% 
  ggplot(aes(elapsed_seconds, CO2_dry, group = samplenum)) + geom_line() + facet_wrap(~SampleID) + xlim(c(0, 25))
```

